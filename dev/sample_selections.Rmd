---
title: "Sample Selections"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

<!--
You need to run the 'description' chunk in the '0-dev_history.Rmd' file before continuing your code there.
-->


# convert_os_df_to_wide 

```{r function-convert_os_df_to_wide }



#' Convert  OS data to wide
#' 
#' Convert OS data to wide and merge with clinical data
#' 
#' @param clinical_df A data frame with clinical data at Find typically from Open Clinica.
#' @param specimen_df A data frame with specimen data at Find generally Open Specimen.
#' @param os_aliquot_names A vector of the aliquot names that you want to use. 
#' @param join_by_col A column used to merge clinical data and specimen data
#' @param join_function A function in char to join with. Recommended to use
#'  dplyr merge function eg left_join, inner_join etc. Recommended to load dplyr 
#' @param specimen_col The column containing specimen names.
#'  At find usually Specimen Requirement name
#' @param clinical_vars A vector of clinical variables.
#'  Ideally variables that usually describe patient characteristics eg sex, 
#'  disease information etc
#' @param specimen_label_col Column containing specimen IDS in Open Specimen this is 
#'  specimen label
#' @importFrom janitor make_clean_names
#' @importFrom data.table setnames setDT 
#' @importFrom purrr reduce
#' @return A wide data frame with one row per participant and one column for
#'   each aliquot name and the number of aliquots and the specimen labels for
#'   that aliquot.
#'
#' @export

convert_os_df_to_wide <- function(clinical_df,
                                  specimen_df, 
                                  join_by_col,
                                  specimen_col,
                                  specimen_label_col,
                                  clinical_vars = NULL ,
                                  os_aliquot_names,
                                  join_function = "left_join") {
  
  # Check if input data frames are provided
  if (is.null(clinical_df) || is.null(specimen_df)) {
    stop("Input data frames 'clinical_df' and 'specimen_df' are required.")
  }
  
  # Check if join_by_col and specimen_col are present in the data frames
  if (!(join_by_col %in% names(clinical_df)) || !(join_by_col %in% names(specimen_df))) {
    stop("The column 'join_by_col' does not exist in the data frames.")
  }
  
  if (!(specimen_col %in% names(specimen_df))) {
    stop("The column 'specimen_col' does not exist in the 'specimen_df' data frame.")
  }
  
  # Check if os_aliquot_names is provided
  if (length(os_aliquot_names) == 0) {
    stop("The 'os_aliquot_names' vector is empty.")
  }
  
  # Clean the aliquot names.
  os_aliquot_names_clean <- make_clean_names(os_aliquot_names)
  
  # Create a list of data frames, one for each aliquot name.
  list_dfs = vector(mode = "list",
                    length = length(os_aliquot_names))
  
  for (i in seq_along(os_aliquot_names)) {
    
    aliq_name = os_aliquot_names[i]
    
    aliq_col_name = os_aliquot_names_clean[i]
    
    no_aliquots = paste0("NP_aliqN_",
                         aliq_col_name)
    aliquots_spec_label = paste0("NP_labels_", 
                                 aliq_col_name)
    
    new_nms = c(no_aliquots, aliquots_spec_label)
    
    old_nms = c("NP_aliqN", "NP_labels")
    # calculate aliquot numbers and 
    
    aliquot_samples_df <- specimen_df[get(specimen_col) == aliq_name,
                                      list(NP_aliqN = .N,
                                        NP_labels = list(get(specimen_label_col))),
                                      by = join_by_col]
    
    
    setnames(aliquot_samples_df,
             old_nms, 
             new_nms)
    
    list_dfs[[i]] = aliquot_samples_df
    
  }
  ## function use to merge data frames
  join_function <- match.fun(join_function)
  # Combine the list of data frames into a single data frame.
  final_df <- list_dfs %>% 
    reduce(join_function,
           by = join_by_col)
  
  # Set the data frame as a data table.
  
  setDT(final_df)
  
  # select only the variables required from clinical data
  if(!is.null(clinical_vars)){
    
    clinical_vars = c(join_by_col, clinical_vars)
    
    clinical_df = clinical_df[, .SD, 
                              .SDcols = clinical_vars]
  }
   ## merge with clinical df
  final_df <- merge(clinical_df,
                    final_df,
                    by = join_by_col,
                    all.x = T)
  
  
  # Return the wide data frame.
  final_df
}
```



```{r example-convert_os_df_to_wide }
library(data.table)
library(dplyr)
data("tb_data", package = "findBiobankR")
data("tb_specimen_df", package = "findBiobankR")

# required clinical cols
clinical_cols <- c("tb_group", "hiv_status", "sex", "country") 

clin_specs  <- convert_os_df_to_wide(clinical_df = tb_data,
                                     specimen_df = tb_specimen_df, 
                                     join_by_col = "ppid",
                                     specimen_col ="specimen_type" ,
                                     clinical_vars = clinical_cols ,
                                     specimen_label_col = "specimen_label",
                                     os_aliquot_names = c("Serum", "Plasma")
)

knitr::kable(clin_specs[1:10, ])
```





```{r tests-convert_os_df_to_wide }
test_that("convert_os_df_to_wide  works", {
  library(data.table)
  data("tb_data", package = "findBiobankR")
  setnames(tb_data, "ppid", "ppid2")
  data("tb_specimen_df", package = "findBiobankR")
  
  expect_error( convert_os_df_to_wide(clinical_df = tb_data,
                                      specimen_df = tb_specimen_df, 
                                      join_by_col = "ppid",
                                      specimen_col ="specimen_type" ,
                                      clinical_vars = clinical_cols ,
                                      os_aliquot_names = c("Serum", "Plasma")),
                regxp ="The column 'join_by_col' does not exist in the data frames." )
})
```



# select_one_aliquot


```{r function-select_one_aliquot}
#' Title Select One aliquot 
#' 
#' Description This function selects a specific aliquot label from a list of objects/ A list column 
#' @param x The input is a list column or a list of vectors 
#' @param aliquot_number The number indicating the position of the desired aliquot label. Defaults to 1.
#' @return A list of selected aliquot labels.
#' @return A vector
#' 
#' @export


select_one_aliquot <- function(x, aliquot_number = 1){
  
  # Check if x is a list
  if (!is.list(x)) {
    stop("Parameter 'x' must be a list.")
  }
  # Check if aliquot_number is numeric
  if (isFALSE(aliquot_number %%1==0 | aliquot_number > 0)) {
    stop("Parameter 'aliquot_number' must be a non negative integer.")
  }
  
  #a list to store the selected aliquot labels
  list_aliquots <- lapply(seq_along(x),function(z){
    
    zx = x[[z]]
    
    if(is.null(zx) ){
      
      ans = NA
      
    }else if(aliquot_number > length(zx)){
      
      warning("Subscript out of bounds returning NA")
      
      ans = NA
      
    }else{
      
      ans = zx[[aliquot_number]] %>% unlist()
    }
    
    ans
  })
  
  unlist(list_aliquots)
}
```




```{r example-select_one_aliquot}
library(data.table)
library(dplyr)
data("tb_data", package = "findBiobankR")
data("tb_specimen_df", package = "findBiobankR")

# required clinical cols
clinical_cols <- c("tb_group", "hiv_status", "sex", "country") 

clin_specs  <- convert_os_df_to_wide(clinical_df = tb_data,
                                     specimen_df = tb_specimen_df, 
                                     join_by_col = "ppid",
                                     specimen_col ="specimen_type" ,
                                     clinical_vars = clinical_cols ,
                                      specimen_label_col = "specimen_label",
                                     os_aliquot_names = c("Serum", "Plasma")
)

##
clin_specs[, select_one_aliquot(NP_labels_serum)]

# or data table way
clin_specs[, serum_aliquot_dt := select_one_aliquot(NP_labels_serum)]
# or tidyverse way
clin_specs %>%
  mutate(serum_aliquot_dp := select_one_aliquot(NP_labels_serum))

knitr::kable(clin_specs[1:10, ])

samples_list <- list(c("TB0990100010101001", "TB0990100010101002", "TB0990100010101003"),
                     c("TB0990100020101001", "TB0990100020101002", "TB0990100020101003"), 
                     c("TB0990100030101001", "TB0990100030101002", "TB0990100030101003"),
                     c("TB0990100040101001", "TB0990100040101002", "TB0990100040101003"),
                     c("TB0990100050101001", "TB0990100050101002", "TB0990100050101003"
                     ))
select_one_aliquot(samples_list, aliquot_number = 2)
```






```{r tests-select_one_aliquot}
test_that("select_one_aliquot works", {
  
  samples_list <- list(c("TB0990100010101001", 
                         "TB0990100010101002",
                         "TB0990100010101003"))
  
  expect_warning(select_one_aliquot(samples_list, aliquot_number = 4),
                 regxp ="Subscript out of bounds returning NA" )
  expect_equal(select_one_aliquot(samples_list, aliquot_number = 1),"TB0990100010101001" )
})
```


# select_many_aliquots


```{r function-select_many_aliquots}
#' Title Select many aliquots 
#'
#' Description Selects multiple aliquots labels from a list of lists.
#'
#' @param x A list of lists containing aliquot labels.
#' @param aliquots The number of aliquots to select.
#'
#' @return A list of vectors, each containing the selected aliquot labels.
#'
#' @export

select_many_aliquots <- function(x, aliquots) {
  
  if (aliquots <= 0){
    stop("Number of aliquots must be specified and greater than 0")
  }
  
  aliquot_pos <- seq_len(aliquots)
  
  nms <- paste0("aliquots", aliquot_pos)
  
  list_aliquots <- vector(mode = "list",
                          length = aliquots)
  
  list_aliquots <- lapply(seq_along(aliquot_pos), function(i){
    
    aliquot_label_i <- select_one_aliquot(x, aliquot_number = i)
    aliquot_label_i
    
    
    
  }
  )
  names(list_aliquots) <- nms
  
  list_aliquots
}
```


```{r example-select_many_aliquots}

samples_list <- list(c("TB0990100010101001", "TB0990100010101002", "TB0990100010101003"),
                     c("TB0990100020101001", "TB0990100020101002", "TB0990100020101003"), 
                     c("TB0990100030101001", "TB0990100030101002", "TB0990100030101003"),
                     c("TB0990100040101001", "TB0990100040101002", "TB0990100040101003"),
                     c("TB0990100050101001", "TB0990100050101002", "TB0990100050101003"
                     ))

## Select two aliquots per patient
aliquots_selected <- select_many_aliquots(samples_list, 
                                          aliquots = 2)

aliquots_selected
```


```{r tests-select_many_aliquots}

library(testthat)

# Define test cases
test_that("select_many_aliquots returns correct aliquots", {
  samples_list <- list(
    c("TB0990100010101001", "TB0990100010101002", "TB0990100010101003"),
    c("TB0990100020101001", "TB0990100020101002", "TB0990100020101003"),
    c("TB0990100030101001", "TB0990100030101002", "TB0990100030101003"),
    c("TB0990100040101001", "TB0990100040101002", "TB0990100040101003"),
    c("TB0990100050101001", "TB0990100050101002", "TB0990100050101003")
  )
  
  # Test case 1
  expected_result_1 <- list(
   aliquots1 =  c("TB0990100010101001", "TB0990100020101001", 
                  "TB0990100030101001", "TB0990100040101001", 
                  "TB0990100050101001"),
    aliquots2 = c("TB0990100010101002", "TB0990100020101002",
                  "TB0990100030101002", "TB0990100040101002",
                  "TB0990100050101002"),
   
   aliquots3 =  c("TB0990100010101003", "TB0990100020101003",
                  "TB0990100030101003", "TB0990100040101003", 
                  "TB0990100050101003"))
   
    result_1 <- select_many_aliquots(samples_list, 3)
    expect_equal(result_1, expected_result_1)
    
    # Test case 2
    expected_result_2 <- list(
      aliquots1 = c("TB0990100010101001", "TB0990100020101001", 
                    "TB0990100030101001", "TB0990100040101001",
                    "TB0990100050101001"
))
    result_2 <- select_many_aliquots(samples_list, 1)
    
    expect_equal(result_2, expected_result_2)
    
    
    # Test case 3
    expect_error(select_many_aliquots(samples_list, 0), 
                 regxp = "Number of aliquots must be specified and greater than 0")
})
  
  
```
  
  
  
```{r development-load}
  # Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```
  
  
  
  
```{r development-inflate, eval=FALSE}
  # Run but keep eval=FALSE to avoid infinite loop
  # Execute in the console directly
fusen::inflate(flat_file = "dev/sample_selections.Rmd",
               vignette_name = "sample-selections-vignette")
```
  
  
