---
title: "sample-selections-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sample-selections-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(findBiobankR)
```

<!-- WARNING - This vignette is generated by {fusen} from dev/sample_selections.Rmd: do not edit by hand -->

<!--
You need to run the 'description' chunk in the '0-dev_history.Rmd' file before continuing your code there.
-->



# convert_os_df_to_wide 

```{r example-convert_os_df_to_wide}
library(data.table)
library(dplyr)
data("tb_data", package = "findBiobankR")
data("tb_specimen_df", package = "findBiobankR")

# required clinical cols
clinical_cols <- c("tb_group", "hiv_status", "sex", "country") 

clin_specs  <- convert_os_df_to_wide(clinical_df = tb_data,
                                     specimen_df = tb_specimen_df, 
                                     join_by_col = "ppid",
                                     specimen_col ="specimen_type" ,
                                     clinical_vars = clinical_cols ,
                                     specimen_label_col = "specimen_label",
                                     os_aliquot_names = c("Serum", "Plasma")
)

knitr::kable(clin_specs[1:10, ])
```

# select_one_aliquot

```{r example-select_one_aliquot}
library(data.table)
library(dplyr)
data("tb_data", package = "findBiobankR")
data("tb_specimen_df", package = "findBiobankR")

# required clinical cols
clinical_cols <- c("tb_group", "hiv_status", "sex", "country") 

clin_specs  <- convert_os_df_to_wide(clinical_df = tb_data,
                                     specimen_df = tb_specimen_df, 
                                     join_by_col = "ppid",
                                     specimen_col ="specimen_type" ,
                                     clinical_vars = clinical_cols ,
                                      specimen_label_col = "specimen_label",
                                     os_aliquot_names = c("Serum", "Plasma")
)

##
clin_specs[, select_one_aliquot(NP_labels_serum)]

# or data table way
clin_specs[, serum_aliquot_dt := select_one_aliquot(NP_labels_serum)]
# or tidyverse way
clin_specs %>%
  mutate(serum_aliquot_dp := select_one_aliquot(NP_labels_serum))

knitr::kable(clin_specs[1:10, ])

samples_list <- list(c("TB0990100010101001", "TB0990100010101002", "TB0990100010101003"),
                     c("TB0990100020101001", "TB0990100020101002", "TB0990100020101003"), 
                     c("TB0990100030101001", "TB0990100030101002", "TB0990100030101003"),
                     c("TB0990100040101001", "TB0990100040101002", "TB0990100040101003"),
                     c("TB0990100050101001", "TB0990100050101002", "TB0990100050101003"
                     ))
select_one_aliquot(samples_list, aliquot_number = 2)
```

# select_many_aliquots

```{r example-select_many_aliquots}

samples_list <- list(c("TB0990100010101001", "TB0990100010101002", "TB0990100010101003"),
                     c("TB0990100020101001", "TB0990100020101002", "TB0990100020101003"), 
                     c("TB0990100030101001", "TB0990100030101002", "TB0990100030101003"),
                     c("TB0990100040101001", "TB0990100040101002", "TB0990100040101003"),
                     c("TB0990100050101001", "TB0990100050101002", "TB0990100050101003"
                     ))

## Select two aliquots per patient
aliquots_selected <- select_many_aliquots(samples_list, 
                                          aliquots = 2)

aliquots_selected
```

  
 # select_patients_per_group
    

```{r example-select_patients_per_group}

library(data.table)
library(dplyr)
data("tb_data", package = "findBiobankR")
data("tb_specimen_df", package = "findBiobankR")

# required clinical cols
clinical_cols <- c("tb_group", "hiv_status", "sex", "country") 

clin_specs  <- convert_os_df_to_wide(clinical_df = tb_data,
                                     specimen_df = tb_specimen_df, 
                                     join_by_col = "ppid",
                                     specimen_col ="specimen_type" ,
                                     clinical_vars = clinical_cols ,
                                     specimen_label_col = "specimen_label",
                                     os_aliquot_names = c("Serum", "Plasma")
)


## select 2 patients per group 
patient_groups  <- c("TB, Neg", "TB, Pos")
number_per_group  <- c(2, 2)
sort_cols = "NP_aliqN_serum"
clin_specs_2 <- select_patients_per_group(df = clin_specs, 
                                          patient_group_col = "tb_group",
                                          patient_groups = patient_groups,
                                          number_per_group = number_per_group,
                                          sort_cols = sort_cols)


```

 

# selected_aliquots_df

    

  

```{r example-selected_aliquots_df}

library(data.table)
library(dplyr)
data("tb_data", package = "findBiobankR")
data("tb_specimen_df", package = "findBiobankR")

# required clinical cols
clinical_cols <- c("tb_group", "hiv_status", "sex", "country") 

clin_specs  <- convert_os_df_to_wide(clinical_df = tb_data,
                                     specimen_df = tb_specimen_df, 
                                     join_by_col = "ppid",
                                     specimen_col ="specimen_type" ,
                                     clinical_vars = clinical_cols ,
                                      specimen_label_col = "specimen_label",
                                     os_aliquot_names = c("Serum", "Plasma")
)


clin_specs[, serum_aliquot := select_one_aliquot(NP_labels_serum, aliquot_number = 1 )]
clin_specs[, plasma_aliquot := select_one_aliquot(NP_labels_plasma, aliquot_number= 1 )]

## prepare data set
selected_aliquots_df(clin_specs,
                     aliquot_cols = c("serum_aliquot","plasma_aliquot"),
                     ppid_col = "ppid")
```

  

# make_clean_os_names

    

  

```{r example-make_clean_os_names}

nms_os <- c("Participant_PPID", "Visit_Visit Site",
            "Visit_Name", "Visit_Event Label", 
            "Specimen_Specimen Label",
            "Specimen_Type", "Specimen_Lineage", "Specimen_Barcode", 
            "Specimen_Container Name", "Specimen_Container Position", 
            "Specimen_Requirement Name", "Collection Protocol_Short Title")

make_clean_os_names(nms_os)
```

  

  

# append_check_col

    

```{r example-append_check_col}

library(data.table)
library(dplyr)
data("tb_data", package = "findBiobankR")
#data("tb_specimen_df", package = "findBiobankR")

# required clinical cols
clinical_cols <- c("tb_group", "hiv_status", "sex", "country") 

clin_specs  <- convert_os_df_to_wide(clinical_df = tb_data,
                                     specimen_df = tb_specimen_df, 
                                     join_by_col = "ppid",
                                     specimen_col ="specimen_type" ,
                                     clinical_vars = clinical_cols ,
                                     specimen_label_col = "specimen_label",
                                     os_aliquot_names = c("Serum", "Plasma")
)


clin_specs[, serum_aliquot := select_one_aliquot(NP_labels_serum, aliquot_number = 1 )]
clin_specs[, plasma_aliquot := select_one_aliquot(NP_labels_plasma, aliquot_number= 1 )]

# or tidyverse way

selected_samples <- selected_aliquots_df(clin_specs,
                                         aliquot_cols = c("serum_aliquot","plasma_aliquot"),
                                         ppid_col = "ppid")

df_send <- append_check_col(selected_samples = selected_samples,
                            os_position = tb_specimen_df,
                            ppid_col = "ppid",
                            specimen_id_col = "specimen_label",
                            os_required_cols = c("ppid",
                                                 "Specimen_Specimen Label",
                                                 "Specimen_Type", 
                                                 "Specimen_Requirement Name", 
                                                 "Specimen_Barcode",
                                                 "Specimen_Container Name", 
                                                 "Specimen_Container Position",
                                                 "Scanned_barcode"))

df_send
```

  
  
  

# process_save_selected_aliquots

    

  

```{r example-process_save_selected_aliquots}

library(data.table)
library(dplyr)
data("tb_data", package = "findBiobankR")
#data("tb_specimen_df", package = "findBiobankR")

# required clinical cols
clinical_cols <- c("tb_group", "hiv_status", "sex", "country") 

clin_specs  <- convert_os_df_to_wide(clinical_df = tb_data,
                                     specimen_df = tb_specimen_df, 
                                     join_by_col = "ppid",
                                     specimen_col ="specimen_type" ,
                                     clinical_vars = clinical_cols ,
                                     specimen_label_col = "specimen_label",
                                     os_aliquot_names = c("Serum", "Plasma")
)


clin_specs[, serum_aliquot := select_one_aliquot(NP_labels_serum, aliquot_number = 1 )]
clin_specs[, plasma_aliquot := select_one_aliquot(NP_labels_plasma, aliquot_number= 1 )]


selected_samples <- selected_aliquots_df(clin_specs,
                                         aliquot_cols = c("serum_aliquot","plasma_aliquot"),
                                         ppid_col = "ppid")

path_name <- tempfile(pattern = "create_work_book") %>%
  normalizePath(winslash = "/")

dir.create(path_name)

# create file name
path_name <- file.path(path_name, "aliquots.xlsx")

process_save_selected_aliquots(file_path = path_name,
                               save_file= TRUE,
                               selected_samples = selected_samples,
                               os_position = tb_specimen_df,
                               ppid_col = "ppid",
                               specimen_id_col = "specimen_label",
                               os_required_cols = c("ppid",
                                                    "Specimen_Specimen Label",
                                                    "Specimen_Type",
                                                    "Specimen_Requirement Name", 
                                                    "Specimen_Barcode",
                                                    "Specimen_Container Name", 
                                                    "Specimen_Container Position",
                                                    "Scanned_barcode"))

```

  

  
  

# create_save_workbook

    

  

```{r example-create_save_workbook}

df1 <- data.frame(x = 1:10, y = 11:20)
df2 <- data.frame(a = letters[1:5], b = letters[6:10])
list_of_dfs <- list(df1, df2)

# Specify the names of the sheets
sheet_names <- c("Sheet1", "Sheet2")

#create temporary folder 
path_name <- tempfile(pattern = "create_work_book") %>%
  normalizePath(winslash = "/")

dir.create(path_name)

# create file name
file_name <- file.path(path_name, "test.xlsx")

# Create the workbook
create_save_workbook(list_of_dfs,
                     path_name = file_name, 
                     sheet_names)
file.remove(file_name)
unlink(path_name)

```

  

  
  

# gen_clinical_data

    

  

```{r example-gen_clinical_data}
library(data.table)
library(dplyr)
data("tb_data", package = "findBiobankR")
data("tb_specimen_df", package = "findBiobankR")
data("tb_dictionary", package = "findBiobankR")
# required clinical cols
clinical_cols <- c("tb_group", "hiv_status", "sex", "country") 

clin_specs  <- convert_os_df_to_wide(clinical_df = tb_data,
                                     specimen_df = tb_specimen_df, 
                                     join_by_col = "ppid",
                                     specimen_col ="specimen_type" ,
                                     clinical_vars = clinical_cols ,
                                     specimen_label_col = "specimen_label",
                                     os_aliquot_names = c("Serum", "Plasma")
)


clin_specs[1:4, serum_aliquot := select_one_aliquot(NP_labels_serum, aliquot_number = 1 )]
clin_specs[1:4, plasma_aliquot := select_one_aliquot(NP_labels_plasma, aliquot_number= 1 )]


selected_samples <- selected_aliquots_df(clin_specs,
                                         aliquot_cols = c("serum_aliquot","plasma_aliquot"),
                                         ppid_col = "ppid")

selected_samples_df <- process_save_selected_aliquots(file_path = NULL,
                               save_file= FALSE,
                               selected_samples = selected_samples,
                               os_position = tb_specimen_df,
                               ppid_col = "ppid",
                               specimen_id_col = "specimen_label",
                               os_required_cols = c("ppid",
                                                    "Specimen_Specimen Label",
                                                    "Specimen_Type",
                                                    "Specimen_Requirement Name", 
                                                    "Specimen_Barcode",
                                                    "Specimen_Container Name", 
                                                    "Specimen_Container Position",
                                                    "Scanned_barcode"))

gen_clinical_data(clinical_data = tb_data,
                  clinical_cols= clinical_cols,
                  dictionary = tb_dictionary,
                  selected_samples_df = selected_samples_df,
                  ppid_col = "ppid",
                  dict_variable = "variable_name",
                  specimen_cols = c("ppid", "Specimen_Specimen Label", "Specimen_Type"),
                  additional_data = NULL )

```

  

  
  
  
  

  
  

